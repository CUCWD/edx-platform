<%page expression_filter="h"/>
<%page args='user, course_enrollments'/>
<%!
from openedx.core.djangoapps.content.course_overviews.models import CourseOverview
from organizations.models import OrganizationInstitution
from common.djangoapps.student.models import AnonymousUserId
from custom_reg_form.models import ExtraInfo
%>

<%namespace name='static' file='../static_content.html'/>

<!-- Ensure that program surveys are only shown to learners who are enrolled in courses from CA organization -->
<% 
show_program_survey = False
course_institution = ''

for enrollment in course_enrollments:
    course_overview = CourseOverview.get_from_id(enrollment.course_id)
    if course_overview.org == "CA":
        show_program_survey = True

        if course_overview.course_institution:
            course_institution = course_overview.course_institution
            break
%>

<!-- If program surveys are being shown to learner, start building strings to pass organization and institution information to qualtrics -->
% if show_program_survey:
    <%
        course_institution = OrganizationInstitution.get_by_shortname(short_name=course_overview.course_institution)

        if user.is_anonymous:
            anonymous_user_id = user.id
        else: 
            anonymous_user_id = AnonymousUserId.objects.filter(user=user, course_id=None).order_by('-id')
            anonymous_user_id = anonymous_user_id[0].anonymous_user_id 

        platform_anonymous_user_id_string = "platform_anonymous_user_id=" + (anonymous_user_id or "")
        username_string = "platform_username=" + (user.username or "")
        platform_fullname = "platform_fullname=" + (user.profile.name or "")
        user_email_string = "platform_email=" + (user.email or "")

        org_institution_name_string = "org_institution_name="
        org_institution_shortname_string = "org_institution_short_name="
        org_institution_city_string = "org_institution_city="
        org_institution_state_string = "org_institution_state="
        org_institution_zipcode_string = "org_institution_zipcode="
        if course_institution is not None:
            org_institution_name_string += (course_institution.name or "")
            org_institution_shortname_string += (course_institution.short_name or "")
            org_institution_city_string += (course_institution.city or "")
            org_institution_state_string += (course_institution.state or "")
            org_institution_zipcode_string += (course_institution.zipcode or "")           

        try:
            demographic_zipcode = "demographic_zipcode=" + (ExtraInfo.objects.get(user_id=user.id).zipcode or "")
        except:
            demographic_zipcode = "demographic_zipcode="

        demographic_country = "demographic_country=" + (str(user.profile.country) or "")
        program_name = "program_name=" + "Aviation Mechanic General"
    %>

    <div class="program-survey">
        <h2 class="program-survey-header">
            Aviation Mechanic General Surveys
        </h2>
        <div class="program-details">
            <p>This program of courses equips learners for entry into the FAA mechanic pathway. Upon completion, they gain foundational knowledge in mathematics, aircraft drawings, weight and balance, aircraft materials, processes and tools, physics, electricity, inspection, ground operations, and FAA regulations governing maintenance technician certification and work.</p>
        </div>

        <div class="survey-details-wrapper">
            <div class="survey-wrapper">
                <h2 class="survey-title">Pre-Program</h2>
                <hr>
                <p class="survey-instructions">New Learner: Take this survey upon program entry.</p>
                <p class="survey-details">This will help us understand your career awareness and interest, gauge where you are with FAA General maintenance knowledge and skill confidence, career plans, and demographic information.</p>
                <a class="provide-feedback-btn" href="https://clemson.qualtrics.com/jfe/form/SV_3C2RY5TuB0uIZ70?${username_string}&${platform_fullname}&${user_email_string}&${platform_anonymous_user_id_string}&${org_institution_name_string}&${org_institution_shortname_string}&${org_institution_city_string}&${org_institution_state_string}&${org_institution_zipcode_string}&${demographic_zipcode}&${demographic_country}&${program_name}" target="_blank">
                    Provide Input</a>
            </div>

            <div class="survey-wrapper">
                <h2 class="survey-title">Post-Program</h2>
                <hr>
                <p class="survey-instructions">Continuing Learner: Take this survey upon program exit.</p>
                <p class="survey-details">This will help us understand your completion of FAA General maintenance program, career awareness and interest, knowledge and skill confidence, and demographic information.</p>
                <a class="provide-feedback-btn" href="https://clemson.qualtrics.com/jfe/form/SV_1Al5SpJgWVv6bFI?${username_string}&${platform_fullname}&${user_email_string}&${platform_anonymous_user_id_string}&${org_institution_name_string}&${org_institution_shortname_string}&${org_institution_city_string}&${org_institution_state_string}&${org_institution_zipcode_string}&${demographic_zipcode}&${demographic_country}&${program_name}" target="_blank">
                Provide Feedback</a>
            </div>
        </div>
    </div>
% endif
